<!DOCTYPE html>
<html lang="pt-br">
<head>
    <title>Instituição - NotaDez</title>
    <link href="styless/base.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div class="container">
        <div class="bemvindo" id="bemvindo"></div>
        <div class="info">
            Informe pelo menos uma instituição onde trabalha e um curso que leciona.<br>
            Exemplo: <b>PUC-Campinas</b> e <b>Engenharia de Software</b>
        </div>
        <h2>Cadastro de Instituição e Curso</h2>
        <form id="instituicaoForm">
            <label for="instituicao">Instituição:</label>
            <input type="text" id="instituicao" name="instituicao" required placeholder="Ex: PUC-Campinas">
            
            <label for="curso">Curso:</label>
            <input type="text" id="curso" name="curso" required placeholder="Ex: Engenharia de Software">
            
            <button type="submit">Continuar para Disciplinas</button>
        </form>

        <div id="instituicoesCadastradas" style="display: none; margin-top: 20px;">
            <h3>Suas Instituições Cadastradas</h3>
            <div id="listaInstituicoes"></div>
            <button type="button" onclick="novaInstituicao()" style="background: #6c757d; margin-top: 10px;">
                + Adicionar outra instituição
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        
        if (!usuarioLogado) {
            window.location.href = 'notadez.html';
        }

        document.getElementById('bemvindo').textContent = `Bem-vindo, ${usuarioLogado.nome}!`;

        // Função para fazer requisições à API
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'notadez.html';
                    return;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro na requisição:', error);
                mostrarMensagem('❌ Erro de conexão com o servidor');
                throw error;
            }
        }

        // Carregar instituições da API
        async function carregarInstituicoes() {
            try {
                const resultado = await apiRequest('/api/instituicoes');
                
                if (resultado.success) {
                    const instituicoes = resultado.data;
                    
                    if (instituicoes.length > 0) {
                        document.getElementById('instituicoesCadastradas').style.display = 'block';
                        const lista = document.getElementById('listaInstituicoes');
                        
                        lista.innerHTML = instituicoes.map(inst => `
                            <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>${inst.nome}</strong> - ${inst.curso}
                                <button onclick="selecionarInstituicao(${inst.id})" style="background: #28a745; margin-left: 10px; padding: 5px 10px;">
                                    Selecionar
                                </button>
                                <button onclick="excluirInstituicao(${inst.id})" style="background: #dc3545; margin-left: 5px; padding: 5px 10px;">
                                    Excluir
                                </button>
                            </div>
                        `).join('');
                    }
                } else {
                    mostrarMensagem('❌ Erro ao carregar instituições');
                }
            } catch (error) {
                console.error('Erro ao carregar instituições:', error);
            }
        }

        // Cadastrar instituição via API
        document.getElementById('instituicaoForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const instituicao = {
                nome: document.getElementById('instituicao').value,
                curso: document.getElementById('curso').value
            };

            try {
                const resultado = await apiRequest('/api/instituicoes', {
                    method: 'POST',
                    body: JSON.stringify(instituicao)
                });

                if (resultado.success) {
                    // Salvar a instituição atual no localStorage para uso posterior
                    localStorage.setItem('instituicaoAtual', JSON.stringify(resultado.data));
                    window.location.href = 'disciplinas.html';
                } else {
                    mostrarMensagem('❌ ' + (resultado.message || 'Erro ao cadastrar instituição'));
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao cadastrar instituição');
            }
        };

        async function selecionarInstituicao(id) {
            try {
                const resultado = await apiRequest(`/api/instituicoes/${id}`);
                
                if (resultado.success) {
                    localStorage.setItem('instituicaoAtual', JSON.stringify(resultado.data));
                    window.location.href = 'disciplinas.html';
                } else {
                    mostrarMensagem('❌ Erro ao selecionar instituição');
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao selecionar instituição');
            }
        }

        async function excluirInstituicao(id) {
            try {
                // Verificar se há disciplinas vinculadas
                const resultadoDisciplinas = await apiRequest(`/api/disciplinas/instituicao/${id}`);
                
                if (resultadoDisciplinas.success && resultadoDisciplinas.data.length > 0) {
                    mostrarMensagem('❌ Não é possível excluir esta instituição pois existem disciplinas vinculadas a ela.');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir esta instituição?')) {
                    const resultado = await apiRequest(`/api/instituicoes/${id}`, {
                        method: 'DELETE'
                    });

                    if (resultado.success) {
                        mostrarMensagem('✅ Instituição excluída com sucesso!');
                        await carregarInstituicoes();
                    } else {
                        mostrarMensagem('❌ ' + (resultado.message || 'Erro ao excluir instituição'));
                    }
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao excluir instituição');
            }
        }

        function novaInstituicao() {
            document.getElementById('instituicaoForm').style.display = 'block';
            document.getElementById('instituicoesCadastradas').style.display = 'none';
        }

        function mostrarMensagem(texto) {
            alert(texto);
        }

        // Inicialização
        (async function init() {
            await carregarInstituicoes();
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br"> 
<head>
    <meta charset="UTF-8">
    <title>NotaDez - AutenticaÃ§Ã£o</title>
    <link href="styless/base.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div class="container">
        <h2>Login NotaDez</h2>
        <form id="loginForm">
            <label for="loginEmail">E-mail:</label>
            <input type="email" id="loginEmail" name="loginEmail" required>
            
            <label for="loginSenha">Senha:</label>
            <input type="password" id="loginSenha" name="loginSenha" required>
            
            <button type="submit">Entrar</button>
        </form>
        
        <div class="link">
            <a href="#" onclick="showCadastro()">Criar conta</a> | 
            <a href="#" onclick="showRecuperar()">Esqueci minha senha</a>
        </div>

        <form id="cadastroForm" style="display:none;">
            <h2>Criar Conta</h2>
            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" required>
            
            <label for="email">E-mail:</label>
            <input type="email" id="email" name="email" required>
            
            <label for="telefone">Telefone celular:</label>
            <input type="tel" id="telefone" name="telefone" required>
            
            <label for="senha">Senha:</label>
            <input type="password" id="senha" name="senha" required>
            
            <button type="submit">Cadastrar</button>
            
            <div class="link">
                <a href="#" onclick="showLogin()">JÃ¡ tenho conta</a>
            </div>
        </form>

        <!-- FORMULÃRIO DE RECUPERAÃ‡ÃƒO DE SENHA -->
        <form id="recuperarForm" style="display:none;">
            <h2>ğŸ” Recuperar Senha</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                Digite seu e-mail cadastrado para receber um link de recuperaÃ§Ã£o
            </p>
            
            <label for="recEmail">E-mail cadastrado:</label>
            <input type="email" id="recEmail" name="recEmail" required placeholder="seu@email.com">
            
            <button type="submit" class="btn-warning">ğŸ“§ Enviar Link de RecuperaÃ§Ã£o</button>
            
            <div class="link">
                <a href="#" onclick="showLogin()">â† Voltar ao Login</a>
            </div>
        </form>

        <!-- BotÃ£o Alterar Perfil -->
        <div id="alterarPerfilSection" style="display: none; margin-top: 20px; text-align: center;">
            <button onclick="irParaPerfil()" class="btn-secondary" style="width: auto; padding: 10px 20px;">
                âš™ï¸ Alterar Perfil
            </button>
        </div>
    </div>

    <script>
        // Verificar se jÃ¡ estÃ¡ logado ao carregar a pÃ¡gina
        window.addEventListener('load', function() {
            const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (usuarioLogado) {
                document.getElementById('alterarPerfilSection').style.display = 'block';
                document.getElementById('loginEmail').value = usuarioLogado.email;
            }
        });

        // FunÃ§Ãµes para trocar entre formulÃ¡rios
        function showCadastro() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('cadastroForm').style.display = 'block';
            document.getElementById('recuperarForm').style.display = 'none';
        }

        function showRecuperar() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('cadastroForm').style.display = 'none';
            document.getElementById('recuperarForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('cadastroForm').style.display = 'none';
            document.getElementById('recuperarForm').style.display = 'none';
        }

        // Ir para a pÃ¡gina de perfil
        function irParaPerfil() {
            window.location.href = 'perfil.html';
        }

        // Sistema de cadastro e login
        document.getElementById('cadastroForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const usuario = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                senha: document.getElementById('senha').value
            };
            
            try {
                // Chamada para API de cadastro
                const response = await fetch('http://localhost:3000/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(usuario)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Salvar token e usuÃ¡rio
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('usuarioLogado', JSON.stringify(data.usuario));
                    
                    alert('âœ… Cadastro realizado com sucesso!');
                    window.location.href = 'instituicao.html';
                } else {
                    alert('âŒ ' + (data.message || 'Erro no cadastro'));
                }
                
            } catch (error) {
                console.error('Erro:', error);
                // Fallback para localStorage se API nÃ£o estiver disponÃ­vel
                const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
                usuarios.push(usuario);
                localStorage.setItem('usuarios', JSON.stringify(usuarios));
                localStorage.setItem('usuarioLogado', JSON.stringify(usuario));
                
                alert('Cadastro realizado com sucesso! (modo offline)');
                window.location.href = 'instituicao.html';
            }
        };

        document.getElementById('loginForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;
            
            try {
                // Chamada para API de login
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, senha })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('usuarioLogado', JSON.stringify(data.usuario));
                    window.location.href = 'instituicao.html';
                } else {
                    alert('âŒ ' + (data.message || 'E-mail ou senha incorretos!'));
                }
                
            } catch (error) {
                console.error('Erro:', error);
                // Fallback para localStorage
                const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
                const usuario = usuarios.find(u => u.email === email && u.senha === senha);
                
                if (usuario) {
                    localStorage.setItem('usuarioLogado', JSON.stringify(usuario));
                    window.location.href = 'instituicao.html';
                } else {
                    alert('E-mail ou senha incorretos! (modo offline)');
                }
            }
        };


        document.getElementById('recuperarForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('recEmail').value;
            
            try {
                // Chamada REAL para sua API
                const response = await fetch('http://localhost:3000/api/auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ' + data.message);
                    showLogin();
                } else {
                    alert('âŒ ' + (data.message || 'Erro ao enviar e-mail de recuperaÃ§Ã£o'));
                }
                
            } catch (error) {
                console.error('Erro:', error);
                // Fallback para localStorage
                const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
                const usuario = usuarios.find(u => u.email === email);
                
                if (!usuario) {
                    alert('Se o e-mail estiver cadastrado, vocÃª receberÃ¡ um link de recuperaÃ§Ã£o em instantes.');
                } else {
                    alert('ğŸ“§ Link de recuperaÃ§Ã£o enviado para seu e-mail! \n\n(Em produÃ§Ã£o, um e-mail real seria enviado)');
                    console.log('ğŸ” Link simulado: recuperar-senha.html?token=simulado&email=' + email);
                }
                showLogin();
            }
        };
    </script>
</body>
</html>

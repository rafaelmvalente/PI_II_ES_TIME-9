<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Alunos - NotaDez</title>
    <link href="styless/alunos.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö NotaDez</h1>
            <div class="user-info">
                <a href="turmas.html">‚Üê Voltar para Turmas</a> | 
                <span id="userInfo"></span>
            </div>
        </div>

        <div class="info-turma" id="infoTurma">
        </div>

        <div class="stats" id="statsAlunos">
        </div>

        <!-- Mensagens -->
        <div id="mensagem" class="mensagem" style="display: none;"></div>

        <div class="section">
            <h2>üìù Cadastrar Aluno Manualmente</h2>
            <form id="alunoForm">
                <label for="matriculaAluno">Matr√≠cula/RA:</label>
                <input type="text" id="matriculaAluno" required placeholder="Ex: 123456, RA2025001">
                
                <label for="nomeAluno">Nome Completo:</label>
                <input type="text" id="nomeAluno" required placeholder="Ex: Jo√£o Silva Santos">
                
                <button type="submit" class="btn-success">‚ûï Adicionar Aluno</button>
            </form>
        </div>

        <div class="section">
            <h2>üìÅ Importar Alunos via CSV</h2>
            <div class="importacao-section">
                <div class="importacao-form">
                    <label for="csvFile">Selecionar arquivo CSV:</label>
                    <input type="file" id="csvFile" accept=".csv" required>
                    <button type="button" onclick="importarCSV()" class="btn-warning" style="margin-top: 15px;">
                        üì§ Importar CSV
                    </button>
                </div>
                <div class="importacao-info">
                    <h4>Formato do CSV:</h4>
                    <p>Use apenas as duas primeiras colunas:</p>
                    <div class="csv-example">
                        Matr√≠cula,Nome<br>
                        11111,Abel Antim√¥nio<br>
                        11112,Bianca Ni√≥bio<br>
                        11113,Carla Pol√¥nio<br>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Nota:</strong> Alunos com matr√≠cula duplicada ser√£o ignorados.
                    </p>
                </div>
            </div>
        </div>

        <div class="selecao-multipla" id="selecaoMultipla">
            <strong id="contadorSelecionados">0 alunos selecionados</strong>
            <button onclick="excluirSelecionados()" class="btn-excluir btn-small" style="margin-left: 15px;">
                üóëÔ∏è Excluir Selecionados
            </button>
            <button onclick="cancelarSelecao()" class="btn-secondary btn-small">
                ‚úñÔ∏è Cancelar
            </button>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2>üë®‚Äçüéì Lista de Alunos</h2>
                <button onclick="ativarSelecaoMultipla()" class="btn-secondary btn-small">
                    üîò Sele√ß√£o M√∫ltipla
                </button>
            </div>
            
            <div class="alunos-grid" id="listaAlunos"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const turmaAtual = JSON.parse(localStorage.getItem('turmaAtual'));
        const disciplinaAtual = JSON.parse(localStorage.getItem('disciplinaAtual'));
        
        if (!usuarioLogado) {
            window.location.href = 'notadez.html';
        }
        if (!turmaAtual || !disciplinaAtual) {
            window.location.href = 'turmas.html';
        }

        document.getElementById('userInfo').innerHTML = 
            `${usuarioLogado.nome} | <a href="notadez.html" onclick="logout()">Sair</a>`;
        
        document.getElementById('infoTurma').innerHTML = `
            <h3>Turma: ${turmaAtual.nome} (${turmaAtual.codigo})</h3>
            <p><strong>Disciplina:</strong> ${disciplinaAtual.nome} (${disciplinaAtual.sigla})</p>
            ${turmaAtual.horario ? `<p><strong>Hor√°rio:</strong> ${turmaAtual.horario}</p>` : ''}
        `;

        let modoSelecao = false;
        let alunosSelecionados = new Set();
        let alunosData = []; // Array para armazenar alunos com IDs

        // Carregar alunos ao iniciar
        carregarAlunos();

        // Fun√ß√£o para fazer requisi√ß√µes √† API
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'notadez.html';
                    return;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                mostrarMensagem('‚ùå Erro de conex√£o com o servidor', 'erro');
                throw error;
            }
        }

        // Cadastrar aluno via API
        document.getElementById('alunoForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const aluno = {
                matricula: document.getElementById('matriculaAluno').value.trim(),
                nome: document.getElementById('nomeAluno').value.trim(),
                turmaId: turmaAtual.id
            };

            if (!aluno.matricula || !aluno.nome) {
                mostrarMensagem('‚ùå Preencha todos os campos!', 'erro');
                return;
            }

            try {
                const resultado = await apiRequest('/api/alunos', {
                    method: 'POST',
                    body: JSON.stringify(aluno)
                });

                if (resultado.success) {
                    mostrarMensagem('‚úÖ Aluno cadastrado com sucesso!', 'sucesso');
                    document.getElementById('alunoForm').reset();
                    await carregarAlunos();
                } else {
                    mostrarMensagem('‚ùå ' + (resultado.message || 'Erro ao cadastrar aluno'), 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao cadastrar aluno', 'erro');
            }
        };

        // Carregar alunos da API
        async function carregarAlunos() {
            try {
                const resultado = await apiRequest(`/api/alunos/turma/${turmaAtual.id}`);
                
                if (resultado.success) {
                    alunosData = resultado.data;
                    
                    document.getElementById('statsAlunos').innerHTML = `
                        <div class="stat-item">üë®‚Äçüéì ${alunosData.length} Alunos Cadastrados</div>
                        <div class="stat-item">üìä ${alunosData.length} Matr√≠culas</div>
                    `;

                    const lista = document.getElementById('listaAlunos');
                    
                    if (alunosData.length === 0) {
                        lista.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">Nenhum aluno cadastrado nesta turma.</p>';
                        return;
                    }

                    lista.innerHTML = alunosData.map((aluno, index) => `
                        <div class="aluno-card">
                            <div class="aluno-info">
                                <div class="aluno-matricula">${aluno.matricula}</div>
                                <div class="aluno-nome">${aluno.nome}</div>
                            </div>
                            <div class="acoes-aluno">
                                ${modoSelecao ? `
                                    <input type="checkbox" class="checkbox-aluno" onchange="toggleSelecao(${aluno.id})" ${alunosSelecionados.has(aluno.id) ? 'checked' : ''}>
                                ` : ''}
                                <button class="btn-excluir btn-small" onclick="excluirAluno(${aluno.id})" ${modoSelecao ? 'style="display:none"' : ''}>
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    mostrarMensagem('‚ùå Erro ao carregar alunos', 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao carregar alunos', 'erro');
            }
        }

        // Importar CSV via API
        async function importarCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarMensagem('‚ùå Selecione um arquivo CSV!', 'erro');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csvContent = e.target.result;
                    
                    const resultado = await apiRequest(`/api/alunos/import/csv/${turmaAtual.id}`, {
                        method: 'POST',
                        body: JSON.stringify({ csv: csvContent })
                    });

                    if (resultado.success) {
                        mostrarMensagem(`‚úÖ ${resultado.data.importados} alunos importados | ‚ö†Ô∏è ${resultado.data.duplicados} duplicados ignorados`, 'sucesso');
                        fileInput.value = '';
                        await carregarAlunos();
                    } else {
                        mostrarMensagem('‚ùå ' + (resultado.message || 'Erro na importa√ß√£o'), 'erro');
                    }
                    
                } catch (error) {
                    mostrarMensagem('‚ùå Erro ao processar arquivo CSV', 'erro');
                }
            };
            
            reader.readAsText(file);
        }

        function ativarSelecaoMultipla() {
            modoSelecao = true;
            alunosSelecionados.clear();
            document.getElementById('selecaoMultipla').style.display = 'block';
            document.getElementById('contadorSelecionados').textContent = '0 alunos selecionados';
            carregarAlunos();
        }

        function toggleSelecao(alunoId) {
            if (alunosSelecionados.has(alunoId)) {
                alunosSelecionados.delete(alunoId);
            } else {
                alunosSelecionados.add(alunoId);
            }
            document.getElementById('contadorSelecionados').textContent = 
                `${alunosSelecionados.size} aluno(s) selecionado(s)`;
        }

        async function excluirSelecionados() {
            if (alunosSelecionados.size === 0) {
                mostrarMensagem('‚ùå Selecione pelo menos um aluno!', 'erro');
                return;
            }

            if (!confirm(`Tem certeza que deseja excluir ${alunosSelecionados.size} aluno(s)?`)) {
                return;
            }

            try {
                const alunoIds = Array.from(alunosSelecionados);
                let sucessos = 0;
                let erros = 0;

                for (const alunoId of alunoIds) {
                    try {
                        const resultado = await apiRequest(`/api/alunos/${alunoId}`, {
                            method: 'DELETE'
                        });
                        if (resultado.success) {
                            sucessos++;
                        } else {
                            erros++;
                        }
                    } catch (error) {
                        erros++;
                    }
                }

                cancelarSelecao();
                await carregarAlunos();
                
                if (erros === 0) {
                    mostrarMensagem(`‚úÖ ${sucessos} aluno(s) exclu√≠do(s) com sucesso!`, 'sucesso');
                } else {
                    mostrarMensagem(`‚ö†Ô∏è ${sucessos} exclu√≠dos | ‚ùå ${erros} erros`, 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao excluir alunos', 'erro');
            }
        }

        function cancelarSelecao() {
            modoSelecao = false;
            alunosSelecionados.clear();
            document.getElementById('selecaoMultipla').style.display = 'none';
            carregarAlunos();
        }

        async function excluirAluno(alunoId) {
            if (!confirm('Tem certeza que deseja excluir este aluno?')) {
                return;
            }

            try {
                const resultado = await apiRequest(`/api/alunos/${alunoId}`, {
                    method: 'DELETE'
                });

                if (resultado.success) {
                    mostrarMensagem('‚úÖ Aluno exclu√≠do com sucesso!', 'sucesso');
                    await carregarAlunos();
                } else {
                    mostrarMensagem('‚ùå ' + (resultado.message || 'Erro ao excluir aluno'), 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao excluir aluno', 'erro');
            }
        }

        function mostrarMensagem(texto, tipo) {
            const mensagemDiv = document.getElementById('mensagem');
            mensagemDiv.textContent = texto;
            mensagemDiv.className = `mensagem ${tipo}`;
            mensagemDiv.style.display = 'block';
            
            setTimeout(() => {
                mensagemDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('token');
        }
        document.head.appendChild(style);
    </script>
</body>
</html>

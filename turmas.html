<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Turmas - NotaDez</title>
    <link href="styless/turmas.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö NotaDez</h1>
            <div class="user-info">
                <a href="disciplinas.html">‚Üê Voltar para Disciplinas</a> | 
                <span id="userInfo"></span>
            </div>
        </div>

        <div class="card">
            <div class="info-disciplina" id="infoDisciplina">
            </div>

            <h2>Cadastrar Nova Turma</h2>
            <form id="turmaForm">
                <label for="nomeTurma">Nome da Turma:</label>
                <input type="text" id="nomeTurma" required placeholder="Ex: Turma A, Turma Noturna, Turma 2025.1">
                
                <label for="codigoTurma">C√≥digo da Turma:</label>
                <input type="text" id="codigoTurma" required placeholder="Ex: T1, TN, 2025-1">
                
                <label for="horarioTurma">Hor√°rio/Aula:</label>
                <input type="text" id="horarioTurma" placeholder="Ex: Segunda 19h-21h, Ter/Qui 14h-16h">
                
                <label for="localTurma">Local:</label>
                <input type="text" id="localTurma" placeholder="Ex: Sala 101, Laborat√≥rio 2, Online">
                
                <button type="submit">Cadastrar Turma</button>
            </form>

            <div class="turmas-grid" id="listaTurmas"></div>
        </div>
    </div>

    <script>
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const disciplinaAtual = JSON.parse(localStorage.getItem('disciplinaAtual'));
        
        if (!usuarioLogado) {
            window.location.href = 'notadez.html';
        }
        if (!disciplinaAtual) {
            window.location.href = 'disciplinas.html';
        }

        document.getElementById('userInfo').innerHTML = 
            `${usuarioLogado.nome} | <a href="notadez.html" onclick="logout()">Sair</a>`;
        
        document.getElementById('infoDisciplina').innerHTML = `
            <h3>Disciplina: ${disciplinaAtual.nome} (${disciplinaAtual.sigla})</h3>
            <p><strong>C√≥digo:</strong> ${disciplinaAtual.codigo} | <strong>Per√≠odo:</strong> ${disciplinaAtual.periodo}</p>
        `;

        carregarTurmas();

        document.getElementById('turmaForm').onsubmit = function(e) {
            e.preventDefault();
            
            const turma = {
                id: Date.now(),
                disciplinaId: disciplinaAtual.id,
                nome: document.getElementById('nomeTurma').value,
                codigo: document.getElementById('codigoTurma').value,
                horario: document.getElementById('horarioTurma').value,
                local: document.getElementById('localTurma').value,
                dataCriacao: new Date().toISOString(),
                usuarioEmail: usuarioLogado.email
            };

            const turmas = JSON.parse(localStorage.getItem('turmas') || '[]');
            turmas.push(turma);
            localStorage.setItem('turmas', JSON.stringify(turmas));

            alert('Turma cadastrada com sucesso!');
            document.getElementById('turmaForm').reset();
            carregarTurmas();
        };

        function carregarTurmas() {
            const turmas = JSON.parse(localStorage.getItem('turmas') || '[]');
            const alunos = JSON.parse(localStorage.getItem('alunos') || '{}');
            const componentes = JSON.parse(localStorage.getItem('componentes') || '[]');
            
            const turmasDaDisciplina = turmas.filter(turma => 
                turma.disciplinaId === disciplinaAtual.id && 
                turma.usuarioEmail === usuarioLogado.email
            );
            
            const lista = document.getElementById('listaTurmas');
            
            if (turmasDaDisciplina.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">Nenhuma turma cadastrada para esta disciplina.</p>';
                return;
            }

            lista.innerHTML = turmasDaDisciplina.map(turma => {
                const alunosTurma = alunos[turma.id] || [];
                const componentesDisciplina = componentes.filter(comp => comp.disciplinaId === disciplinaAtual.id);
                const temNotasLancadas = verificarNotasLancadas(turma.id, componentesDisciplina);
                
                return `
                    <div class="turma-card">
                        <h3>${turma.nome} (${turma.codigo})</h3>
                        ${turma.horario ? `<p><strong>Hor√°rio:</strong> ${turma.horario}</p>` : ''}
                        ${turma.local ? `<p><strong>Local:</strong> ${turma.local}</p>` : ''}
                        
                        <div class="stats">
                            <div class="stat-item">üë®‚Äçüéì ${alunosTurma.length} alunos</div>
                            <div class="stat-item">üìä ${componentesDisciplina.length} componentes</div>
                            ${temNotasLancadas ? '<div class="stat-item">‚úÖ Notas lan√ßadas</div>' : ''}
                        </div>
                        
                        <div class="acoes-turma">
                            <button class="btn-small btn-success" onclick="gerenciarAlunos(${turma.id})">
                                üë®‚Äçüéì Gerenciar Alunos
                            </button>
                            <button class="btn-small" onclick="gerenciarNotas(${turma.id})">
                                üìä Lan√ßar Notas
                            </button>
                            <button class="btn-small btn-excluir" onclick="excluirTurma(${turma.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function verificarNotasLancadas(turmaId, componentes) {
            const notas = JSON.parse(localStorage.getItem('notas') || '{}');
            return Object.keys(notas).some(key => key.startsWith(`${turmaId}-`));
        }

        function gerenciarAlunos(turmaId) {
            const turmas = JSON.parse(localStorage.getItem('turmas') || '[]');
            const turma = turmas.find(t => t.id === turmaId);
            
            if (turma) {
                localStorage.setItem('turmaAtual', JSON.stringify(turma));
                window.location.href = 'alunos.html';
            }
        }

        function gerenciarNotas(turmaId) {
            const turmas = JSON.parse(localStorage.getItem('turmas') || '[]');
            const turma = turmas.find(t => t.id === turmaId);
            
            if (turma) {
                localStorage.setItem('turmaAtual', JSON.stringify(turma));
                window.location.href = 'lancar-notas.html';
            }
        }

        function excluirTurma(id) {
            const turmas = JSON.parse(localStorage.getItem('turmas') || '[]');
            const turma = turmas.find(t => t.id === id);
            
            const alunos = JSON.parse(localStorage.getItem('alunos') || '{}');
            const alunosTurma = alunos[id] || [];
            const temNotasLancadas = verificarNotasLancadas(id, []);
            
            if (alunosTurma.length > 0 || temNotasLancadas) {
                if (confirm('Esta turma possui alunos cadastrados e/ou notas lan√ßadas. Tem certeza que deseja excluir? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    const novasTurmas = turmas.filter(t => t.id !== id);
                    localStorage.setItem('turmas', JSON.stringify(novasTurmas));
                    
                    delete alunos[id];
                    localStorage.setItem('alunos', JSON.stringify(alunos));
                    
                    const notas = JSON.parse(localStorage.getItem('notas') || '{}');
                    Object.keys(notas).forEach(key => {
                        if (key.startsWith(`${id}-`)) {
                            delete notas[key];
                        }
                    });
                    localStorage.setItem('notas', JSON.stringify(notas));
                    
                    carregarTurmas();
                }
            } else {
                if (confirm('Tem certeza que deseja excluir esta turma?')) {
                    const novasTurmas = turmas.filter(t => t.id !== id);
                    localStorage.setItem('turmas', JSON.stringify(novasTurmas));
                    carregarTurmas();
                }
            }
        }

        function logout() {
            localStorage.removeItem('usuarioLogado');
        }
    </script>
</body>
</html>

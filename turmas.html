<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Turmas - NotaDez</title>
    <link href="styless/turmas.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö NotaDez</h1>
            <div class="user-info">
                <a href="disciplinas.html">‚Üê Voltar para Disciplinas</a> | 
                <span id="userInfo"></span>
            </div>
        </div>

        <div class="card">
            <div class="info-disciplina" id="infoDisciplina">
            </div>

            <h2>Cadastrar Nova Turma</h2>
            <form id="turmaForm">
                <label for="nomeTurma">Nome da Turma:</label>
                <input type="text" id="nomeTurma" required placeholder="Ex: Turma A, Turma Noturna, Turma 2025.1">
                
                <label for="codigoTurma">C√≥digo da Turma:</label>
                <input type="text" id="codigoTurma" required placeholder="Ex: T1, TN, 2025-1">
                
                <label for="horarioTurma">Hor√°rio/Aula:</label>
                <input type="text" id="horarioTurma" placeholder="Ex: Segunda 19h-21h, Ter/Qui 14h-16h">
                
                <label for="localTurma">Local:</label>
                <input type="text" id="localTurma" placeholder="Ex: Sala 101, Laborat√≥rio 2, Online">
                
                <button type="submit">Cadastrar Turma</button>
            </form>

            <div class="turmas-grid" id="listaTurmas"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const disciplinaAtual = JSON.parse(localStorage.getItem('disciplinaAtual'));
        
        if (!usuarioLogado) {
            window.location.href = 'notadez.html';
        }
        if (!disciplinaAtual) {
            window.location.href = 'disciplinas.html';
        }

        document.getElementById('userInfo').innerHTML = 
            `${usuarioLogado.nome} | <a href="notadez.html" onclick="logout()">Sair</a>`;
        
        document.getElementById('infoDisciplina').innerHTML = `
            <h3>Disciplina: ${disciplinaAtual.nome} (${disciplinaAtual.sigla})</h3>
            <p><strong>C√≥digo:</strong> ${disciplinaAtual.codigo} | <strong>Per√≠odo:</strong> ${disciplinaAtual.periodo}</p>
        `;

        // Fun√ß√£o para fazer requisi√ß√µes √† API
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'notadez.html';
                    return;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                mostrarMensagem('‚ùå Erro de conex√£o com o servidor');
                throw error;
            }
        }

        // Carregar turmas da API
        async function carregarTurmas() {
            try {
                const resultado = await apiRequest(`/api/turmas/disciplina/${disciplinaAtual.id}`);
                
                if (resultado.success) {
                    const turmas = resultado.data;
                    const lista = document.getElementById('listaTurmas');
                    
                    if (turmas.length === 0) {
                        lista.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">Nenhuma turma cadastrada para esta disciplina.</p>';
                        return;
                    }

                    // Carregar estat√≠sticas para cada turma
                    const turmasComStats = await Promise.all(
                        turmas.map(async (turma) => {
                            const [alunosResult, componentesResult, notasResult] = await Promise.all([
                                apiRequest(`/api/alunos/turma/${turma.id}`),
                                apiRequest(`/api/componentes/disciplina/${disciplinaAtual.id}`),
                                apiRequest(`/api/notas/turma/${turma.id}`)
                            ]);

                            return {
                                ...turma,
                                alunosCount: alunosResult.success ? alunosResult.data.length : 0,
                                componentesCount: componentesResult.success ? componentesResult.data.length : 0,
                                temNotasLancadas: notasResult.success && notasResult.data.length > 0
                            };
                        })
                    );

                    lista.innerHTML = turmasComStats.map(turma => {
                        return `
                            <div class="turma-card">
                                <h3>${turma.nome} (${turma.codigo})</h3>
                                ${turma.horario ? `<p><strong>Hor√°rio:</strong> ${turma.horario}</p>` : ''}
                                ${turma.local ? `<p><strong>Local:</strong> ${turma.local}</p>` : ''}
                                
                                <div class="stats">
                                    <div class="stat-item">üë®‚Äçüéì ${turma.alunosCount} alunos</div>
                                    <div class="stat-item">üìä ${turma.componentesCount} componentes</div>
                                    ${turma.temNotasLancadas ? '<div class="stat-item">‚úÖ Notas lan√ßadas</div>' : ''}
                                </div>
                                
                                <div class="acoes-turma">
                                    <button class="btn-small btn-success" onclick="gerenciarAlunos(${turma.id})">
                                        üë®‚Äçüéì Gerenciar Alunos
                                    </button>
                                    <button class="btn-small" onclick="gerenciarNotas(${turma.id})">
                                        üìä Lan√ßar Notas
                                    </button>
                                    <button class="btn-small btn-excluir" onclick="excluirTurma(${turma.id})">
                                        üóëÔ∏è Excluir
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    mostrarMensagem('‚ùå Erro ao carregar turmas');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao carregar turmas');
            }
        }

        // Cadastrar turma via API
        document.getElementById('turmaForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const turma = {
                disciplinaId: disciplinaAtual.id,
                nome: document.getElementById('nomeTurma').value,
                codigo: document.getElementById('codigoTurma').value,
                horario: document.getElementById('horarioTurma').value,
                local: document.getElementById('localTurma').value
            };

            try {
                const resultado = await apiRequest('/api/turmas', {
                    method: 'POST',
                    body: JSON.stringify(turma)
                });

                if (resultado.success) {
                    mostrarMensagem('‚úÖ Turma cadastrada com sucesso!');
                    document.getElementById('turmaForm').reset();
                    await carregarTurmas();
                } else {
                    mostrarMensagem('‚ùå ' + (resultado.message || 'Erro ao cadastrar turma'));
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao cadastrar turma');
            }
        };

        async function gerenciarAlunos(turmaId) {
            try {
                const resultado = await apiRequest(`/api/turmas/${turmaId}`);
                
                if (resultado.success) {
                    localStorage.setItem('turmaAtual', JSON.stringify(resultado.data));
                    window.location.href = 'alunos.html';
                } else {
                    mostrarMensagem('‚ùå Erro ao carregar turma');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao carregar turma');
            }
        }

        async function gerenciarNotas(turmaId) {
            try {
                const resultado = await apiRequest(`/api/turmas/${turmaId}`);
                
                if (resultado.success) {
                    localStorage.setItem('turmaAtual', JSON.stringify(resultado.data));
                    window.location.href = 'lancar-notas.html';
                } else {
                    mostrarMensagem('‚ùå Erro ao carregar turma');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao carregar turma');
            }
        }

        async function excluirTurma(id) {
            try {
                // Verificar se h√° alunos ou notas vinculadas
                const [alunosResult, notasResult] = await Promise.all([
                    apiRequest(`/api/alunos/turma/${id}`),
                    apiRequest(`/api/notas/turma/${id}`)
                ]);

                const temAlunos = alunosResult.success && alunosResult.data.length > 0;
                const temNotas = notasResult.success && notasResult.data.length > 0;

                if (temAlunos || temNotas) {
                    const mensagem = 'Esta turma possui ' + 
                        (temAlunos ? 'alunos cadastrados' : '') +
                        (temAlunos && temNotas ? ' e ' : '') +
                        (temNotas ? 'notas lan√ßadas' : '') +
                        '. Tem certeza que deseja excluir? Esta a√ß√£o n√£o pode ser desfeita.';
                    
                    if (confirm(mensagem)) {
                        await excluirTurmaComDados(id);
                    }
                } else {
                    if (confirm('Tem certeza que deseja excluir esta turma?')) {
                        await excluirTurmaComDados(id);
                    }
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao verificar dados da turma');
            }
        }

        async function excluirTurmaComDados(id) {
            try {
                const resultado = await apiRequest(`/api/turmas/${id}`, {
                    method: 'DELETE'
                });

                if (resultado.success) {
                    mostrarMensagem('‚úÖ Turma exclu√≠da com sucesso!');
                    await carregarTurmas();
                } else {
                    mostrarMensagem('‚ùå ' + (resultado.message || 'Erro ao excluir turma'));
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao excluir turma');
            }
        }

        function mostrarMensagem(texto) {
            alert(texto);
        }

        function logout() {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('token');
        }

        // Inicializa√ß√£o
        (async function init() {
            await carregarTurmas();
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Disciplinas - NotaDez</title>
    <link href="styless/base.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NotaDez</h1>
            <div class="user-info">
                <a href="instituicao.html">← Voltar</a> | 
                <span id="userInfo"></span>
            </div>
        </div>
        <div class="card">
            <h2>Gerenciar Disciplinas</h2>
            
            <form id="disciplinaForm">
                <div class="form-group">
                    <label for="instituicaoSelect">Instituição:</label>
                    <select id="instituicaoSelect" required>
                        <option value="">Selecione uma instituição</option>
                    </select>
                </div>
                
                <label for="nomeDisciplina">Nome da disciplina:</label>
                <input type="text" id="nomeDisciplina" required placeholder="Ex: Cálculo I">
                
                <label for="siglaDisciplina">Sigla:</label>
                <input type="text" id="siglaDisciplina" required placeholder="Ex: CALC1">
                
                <label for="codigoDisciplina">Código:</label>
                <input type="text" id="codigoDisciplina" required placeholder="Ex: MAT001">
                
                <label for="periodoDisciplina">Período/Semestre:</label>
                <input type="text" id="periodoDisciplina" required placeholder="Ex: 2025.1, 1º Semestre">
                
                <button type="submit">Cadastrar Disciplina</button>
            </form>

            <div class="disciplinas-grid" id="listaDisciplinas"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        
        if (!usuarioLogado) {
            window.location.href = 'notadez.html';
        }

        document.getElementById('userInfo').innerHTML = 
            `${usuarioLogado.nome} | <a href="notadez.html" onclick="logout()">Sair</a>`;

        // Função para fazer requisições à API
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'notadez.html';
                    return;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro na requisição:', error);
                mostrarMensagem('❌ Erro de conexão com o servidor');
                throw error;
            }
        }

        // Carregar instituições da API
        async function carregarInstituicoes() {
            try {
                const resultado = await apiRequest('/api/instituicoes');
                
                if (resultado.success) {
                    const instituicoes = resultado.data;
                    const select = document.getElementById('instituicaoSelect');
                    select.innerHTML = '<option value="">Selecione uma instituição</option>' +
                        instituicoes.map(inst => 
                            `<option value="${inst.id}">${inst.nome} - ${inst.curso}</option>`
                        ).join('');
                } else {
                    mostrarMensagem('❌ Erro ao carregar instituições');
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao carregar instituições');
            }
        }

        // Carregar disciplinas da API
        async function carregarDisciplinas() {
            try {
                const resultado = await apiRequest('/api/disciplinas');
                
                if (resultado.success) {
                    const disciplinas = resultado.data;
                    const lista = document.getElementById('listaDisciplinas');
                    
                    if (disciplinas.length === 0) {
                        lista.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma disciplina cadastrada ainda.</p>';
                        return;
                    }

                    lista.innerHTML = disciplinas.map(disc => {
                        return `
                            <div class="disciplina-card">
                                <h3>${disc.nome} (${disc.sigla})</h3>
                                <p><strong>Instituição:</strong> ${disc.instituicaoNome || 'N/A'}</p>
                                <p><strong>Código:</strong> ${disc.codigo}</p>
                                <p><strong>Período:</strong> ${disc.periodo}</p>
                                <div class="acoes-disciplina">
                                    <button class="btn-small" onclick="gerenciarTurmas(${disc.id})">
                                        Gerenciar Turmas
                                    </button>
                                    <button class="btn-small btn-secondary" onclick="editarDisciplina(${disc.id})">
                                        Editar
                                    </button>
                                    <button class="btn-small btn-excluir" onclick="excluirDisciplina(${disc.id})">
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    mostrarMensagem('❌ Erro ao carregar disciplinas');
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao carregar disciplinas');
            }
        }

        // Cadastrar disciplina via API
        document.getElementById('disciplinaForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const instituicaoId = parseInt(document.getElementById('instituicaoSelect').value);
            if (!instituicaoId) {
                mostrarMensagem('❌ Selecione uma instituição!');
                return;
            }
            
            const disciplina = {
                instituicaoId: instituicaoId,
                nome: document.getElementById('nomeDisciplina').value,
                sigla: document.getElementById('siglaDisciplina').value,
                codigo: document.getElementById('codigoDisciplina').value,
                periodo: document.getElementById('periodoDisciplina').value
            };

            try {
                const resultado = await apiRequest('/api/disciplinas', {
                    method: 'POST',
                    body: JSON.stringify(disciplina)
                });

                if (resultado.success) {
                    mostrarMensagem('✅ Disciplina cadastrada com sucesso!');
                    document.getElementById('disciplinaForm').reset();
                    await carregarDisciplinas();
                } else {
                    mostrarMensagem('❌ ' + (resultado.message || 'Erro ao cadastrar disciplina'));
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao cadastrar disciplina');
            }
        };

        async function gerenciarTurmas(disciplinaId) {
            try {
                const resultado = await apiRequest(`/api/disciplinas/${disciplinaId}`);
                
                if (resultado.success) {
                    localStorage.setItem('disciplinaAtual', JSON.stringify(resultado.data));
                    window.location.href = 'turmas.html';
                } else {
                    mostrarMensagem('❌ Erro ao carregar disciplina');
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao carregar disciplina');
            }
        }

        async function excluirDisciplina(id) {
            try {
                // Verificar se há turmas vinculadas
                const resultadoTurmas = await apiRequest(`/api/turmas/disciplina/${id}`);
                
                if (resultadoTurmas.success && resultadoTurmas.data.length > 0) {
                    mostrarMensagem('❌ Não é possível excluir esta disciplina pois existem turmas vinculadas a ela.');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir esta disciplina?')) {
                    const resultado = await apiRequest(`/api/disciplinas/${id}`, {
                        method: 'DELETE'
                    });

                    if (resultado.success) {
                        mostrarMensagem('✅ Disciplina excluída com sucesso!');
                        await carregarDisciplinas();
                    } else {
                        mostrarMensagem('❌ ' + (resultado.message || 'Erro ao excluir disciplina'));
                    }
                }
            } catch (error) {
                mostrarMensagem('❌ Erro ao excluir disciplina');
            }
        }

        function editarDisciplina(id) {
            // Implementar edição de disciplina
            mostrarMensagem('Funcionalidade de edição em desenvolvimento');
        }

        function mostrarMensagem(texto) {
            alert(texto);
        }

        function logout() {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('token');
        }

        // Inicialização
        (async function init() {
            await carregarInstituicoes();
            await carregarDisciplinas();
        })();
    </script>
</body>
</html>

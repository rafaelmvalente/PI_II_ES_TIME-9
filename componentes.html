<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Lan√ßar Notas - NotaDez</title>
  <link href="styless/componentes.css" rel="stylesheet" type="text/css"/>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö NotaDez</h1>
      <div class="user-info">
        <a href="turmas.html">‚Üê Voltar para Turmas</a> |
        <span id="userInfo"></span>
      </div>
    </div>

    <div class="card">
      <div id="infoTopo" class="row" style="margin-bottom:16px;"></div>

      <!-- Sele√ß√£o de aluno -->
      <div class="field">
        <label for="alunoSelect">Aluno</label>
        <select id="alunoSelect"></select>
      </div>

      <!-- Entradas de notas -->
      <div class="grid-3" style="margin-top:10px;">
        <div class="field">
          <label for="nota1">Nota 1</label>
          <input type="number" id="nota1" min="0" max="10" step="0.1" placeholder="0 a 10">
        </div>
        <div class="field">
          <label for="nota2">Nota 2</label>
          <input type="number" id="nota2" min="0" max="10" step="0.1" placeholder="0 a 10">
        </div>
        <div class="field">
          <label for="nota3">Nota 3</label>
          <input type="number" id="nota3" min="0" max="10" step="0.1" placeholder="0 a 10">
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-success" id="btnSalvar">‚ûï Cadastrar/Salvar Notas</button>
        <button class="btn" id="btnMedia">üßÆ Calcular M√©dia</button>
        <button class="btn btn-secondary" id="btnLer">üìñ Ler Notas do Aluno</button>
        <button class="btn btn-warning" onclick="exportarNotas()">üì§ Exportar Notas</button>
      </div>

      <div class="row" style="margin-top:16px;">
        <span class="chip" id="chipStatus">Nenhum c√°lculo ainda</span>
      </div>

      <div style="margin-top:16px;">
        <h3>Notas do aluno selecionado</h3>
        <div id="boxNotas" class="notas-lista"></div>
        <h3>M√©dia</h3>
        <div id="boxMedia" class="notas-lista"></div>
      </div>
    </div>

    <!-- Tabela de resumo -->
    <div class="card" style="margin-top:20px;">
      <h2>üë®‚Äçüéì Alunos da turma</h2>
      <table class="table" id="tabelaAlunos">
        <thead>
          <tr>
            <th>Matr√≠cula</th>
            <th>Nome</th>
            <th>Notas</th>
            <th>M√©dia</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbodyAlunos"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000';
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    const turmaAtual = JSON.parse(localStorage.getItem('turmaAtual'));
    const disciplinaAtual = JSON.parse(localStorage.getItem('disciplinaAtual'));

    if (!usuarioLogado) { window.location.href = 'notadez.html'; }
    if (!turmaAtual || !disciplinaAtual) { window.location.href = 'turmas.html'; }

    document.getElementById('userInfo').innerHTML = 
      `${usuarioLogado.nome} | <a href="notadez.html" onclick="logout()">Sair</a>`;

    document.getElementById('infoTopo').innerHTML = `
      <span class="chip"><strong>Disciplina:</strong> ${disciplinaAtual.nome} (${disciplinaAtual.sigla})</span>
      <span class="chip"><strong>Turma:</strong> ${turmaAtual.nome} (${turmaAtual.codigo})</span>
      ${turmaAtual.horario ? `<span class="chip"><strong>Hor√°rio:</strong> ${turmaAtual.horario}</span>` : '' }
    `;

    let alunosData = [];
    let componentesData = [];

    // Carregar dados iniciais
    carregarAlunos();
    carregarComponentes();

    // Fun√ß√£o para fazer requisi√ß√µes √† API
    async function apiRequest(endpoint, options = {}) {
      const token = localStorage.getItem('token');
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...(token && { 'Authorization': `Bearer ${token}` }),
          ...options.headers
        },
        ...options
      };

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, config);
        
        if (response.status === 401) {
          localStorage.removeItem('token');
          localStorage.removeItem('usuarioLogado');
          window.location.href = 'notadez.html';
          return;
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Erro na requisi√ß√£o:', error);
        mostrarMensagem('‚ùå Erro de conex√£o com o servidor');
        throw error;
      }
    }

    // Carregar alunos da API
    async function carregarAlunos() {
      try {
        const resultado = await apiRequest(`/api/alunos/turma/${turmaAtual.id}`);
        
        if (resultado.success) {
          alunosData = resultado.data;
          
          const alunoSelect = document.getElementById('alunoSelect');
          alunoSelect.innerHTML = alunosData.length
            ? alunosData.map(a => `<option value="${a.id}">${a.matricula} - ${a.nome}</option>`).join('')
            : '<option value="">Nenhum aluno cadastrado</option>';

          await carregarNotasTurma();
        } else {
          mostrarMensagem('‚ùå Erro ao carregar alunos');
        }
      } catch (error) {
        mostrarMensagem('‚ùå Erro ao carregar alunos');
      }
    }

    // Carregar componentes da disciplina
    async function carregarComponentes() {
      try {
        const resultado = await apiRequest(`/api/componentes/disciplina/${disciplinaAtual.id}`);
        
        if (resultado.success) {
          componentesData = resultado.data;
          // Aqui voc√™ pode adaptar para usar componentes din√¢micos se quiser
        }
      } catch (error) {
        console.error('Erro ao carregar componentes:', error);
      }
    }

    // Carregar notas da turma
    async function carregarNotasTurma() {
      try {
        const resultado = await apiRequest(`/api/notas/turma/${turmaAtual.id}`);
        
        if (resultado.success) {
          atualizarTabela(resultado.data);
        }
      } catch (error) {
        console.error('Erro ao carregar notas:', error);
      }
    }

    function parseNota(id) {
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v) ? null : v;
    }

    function limparCampos() { 
      ['nota1','nota2','nota3'].forEach(id => document.getElementById(id).value = ''); 
    }

    function setStatus(msg, ok=false) {
      const chip = document.getElementById('chipStatus');
      chip.textContent = msg;
      chip.style.borderLeftColor = ok ? '#28a745' : '#007bff';
    }

    function renderNotas(alvo, notas) {
      if (!notas || (notas.n1==null && notas.n2==null && notas.n3==null)) {
        alvo.innerHTML = '<p>‚Äî</p>'; return;
      }
      const p = (v) => v==null ? '‚Äî' : v.toFixed(2);
      alvo.innerHTML = `
        <p>Nota 1: <strong>${p(notas.n1)}</strong></p>
        <p>Nota 2: <strong>${p(notas.n2)}</strong></p>
        <p>Nota 3: <strong>${p(notas.n3)}</strong></p>
      `;
    }

    // Cadastrar notas via API
    async function cadastrarNotas() {
      const alunoId = document.getElementById('alunoSelect').value;
      if (!alunoId) { 
        mostrarMensagem('‚ùå Selecione um aluno.');
        return; 
      }

      const n1 = parseNota('nota1');
      const n2 = parseNota('nota2');
      const n3 = parseNota('nota3');

      if (n1==null || n2==null || n3==null) {
        mostrarMensagem('‚ùå Preencha todas as notas.');
        return;
      }

      try {
        const notasData = {
          alunoId: parseInt(alunoId),
          turmaId: turmaAtual.id,
          notas: {
            n1: n1,
            n2: n2, 
            n3: n3
          }
        };

        const resultado = await apiRequest('/api/notas', {
          method: 'POST',
          body: JSON.stringify(notasData)
        });

        if (resultado.success) {
          renderNotas(document.getElementById('boxNotas'), notasData.notas);
          document.getElementById('boxMedia').innerHTML = '';
          setStatus('‚úÖ Notas salvas!', true);
          await carregarNotasTurma();
        } else {
          mostrarMensagem('‚ùå ' + (resultado.message || 'Erro ao salvar notas'));
        }
      } catch (error) {
        mostrarMensagem('‚ùå Erro ao salvar notas');
      }
    }

    // Ler notas do aluno via API
    async function lerNotasAluno() {
      const alunoId = document.getElementById('alunoSelect').value;
      if (!alunoId) { 
        mostrarMensagem('‚ùå Selecione um aluno.');
        return; 
      }

      try {
        const resultado = await apiRequest(`/api/notas/aluno/${alunoId}/turma/${turmaAtual.id}`);
        
        if (resultado.success) {
          const notas = resultado.data?.notas || {};
          renderNotas(document.getElementById('boxNotas'), notas);
          document.getElementById('boxMedia').innerHTML = '';
          setStatus(resultado.data ? 'üìñ Notas carregadas.' : '‚ÑπÔ∏è Nenhuma nota cadastrada.');
          
          if (resultado.data) {
            document.getElementById('nota1').value = notas.n1 ?? '';
            document.getElementById('nota2').value = notas.n2 ?? '';
            document.getElementById('nota3').value = notas.n3 ?? '';
          } else {
            limparCampos();
          }
        } else {
          mostrarMensagem('‚ùå Erro ao carregar notas');
        }
      } catch (error) {
        mostrarMensagem('‚ùå Erro ao carregar notas');
      }
    }

    function calcularMediaAluno() {
      const n1 = parseNota('nota1');
      const n2 = parseNota('nota2');
      const n3 = parseNota('nota3');

      if (n1==null || n2==null || n3==null) {
        mostrarMensagem('‚ùå Preencha todas as notas primeiro.');
        return;
      }

      const valores = [n1, n2, n3].filter(v => typeof v === 'number');
      const media = valores.reduce((a,b)=>a+b,0) / valores.length;

      document.getElementById('boxMedia').innerHTML = `<p><strong>M√©dia:</strong> ${media.toFixed(2)}</p>`;
      setStatus('üßÆ M√©dia calculada.', true);
    }

    function atualizarTabela(notasTurma) {
      const tbody = document.getElementById('tbodyAlunos');
      tbody.innerHTML = alunosData.map(aluno => {
        const notasAluno = notasTurma.find(n => n.alunoId === aluno.id);
        const notas = notasAluno?.notas || {};
        
        let notasTxt = '‚Äî';
        let mediaTxt = '‚Äî';
        let classe = 'warn';

        if (notasAluno) {
          const n1 = notas.n1 ?? null;
          const n2 = notas.n2 ?? null;
          const n3 = notas.n3 ?? null;
          const arr = [n1,n2,n3].filter(v => typeof v === 'number');
          notasTxt = `N1:${n1??'‚Äî'} | N2:${n2??'‚Äî'} | N3:${n3??'‚Äî'}`;
          if (arr.length) {
            const m = arr.reduce((a,b)=>a+b,0)/arr.length;
            mediaTxt = m.toFixed(2);
            classe = m >= 6 ? 'ok' : 'warn';
          }
        }

        return `
          <tr>
            <td>${aluno.matricula}</td>
            <td>${aluno.nome}</td>
            <td>${notasTxt}</td>
            <td class="${classe}">${mediaTxt}</td>
            <td><button class="btn btn-secondary" onclick="selecionarAluno(${aluno.id})">Editar</button></td>
          </tr>
        `;
      }).join('');
    }

    function selecionarAluno(alunoId) {
      document.getElementById('alunoSelect').value = alunoId;
      lerNotasAluno();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exportarNotas() {
      window.location.href = 'exportar.html';
    }

    function mostrarMensagem(texto) {
      alert(texto);
    }

    document.getElementById('btnSalvar').addEventListener('click', cadastrarNotas);
    document.getElementById('btnLer').addEventListener('click', lerNotasAluno);
    document.getElementById('btnMedia').addEventListener('click', calcularMediaAluno);

    // Inicializa√ß√£o
    (function init() {
      if (alunosData.length === 0) {
        setStatus('üë• Cadastre alunos nesta turma para lan√ßar notas.');
      } else {
        setStatus('üìù Selecione um aluno e informe as tr√™s notas.');
      }
    })();

    function logout() {
      localStorage.removeItem('usuarioLogado');
      localStorage.removeItem('token');
    }
  </script>
</body>
</html>
